pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                sh 'dotnet build'
            }
        }

        stage('Test') {
            steps {
                // Create directory for test results
                sh 'mkdir -p TestResults/Coverage'

                // Run tests with TRX and JUnit loggers
                sh '''
                dotnet test --no-build test/LiveUtils.Tests \
                  --collect:"XPlat Code Coverage" \
                  --logger "trx;LogFileName=LiveUtils.trx" \
                  --logger "junit;LogFileName=liveutils-junit.xml" \
                  --results-directory TestResults
                '''
                sh '''
                dotnet test --no-build test/LiveUtils.LiveSeekData.Tests \
                  --collect:"XPlat Code Coverage" \
                  --logger "trx;LogFileName=LiveSeekData.trx" \
                  --logger "junit;LogFileName=liveseekdata-junit.xml" \
                  --results-directory TestResults
                '''
            }
        }

        stage('Generate HTML Reports') {
            steps {
                // Install trxlog2html .NET tool (if not already installed)
                sh 'dotnet tool install -g dotnet-reportgenerator-globaltool'
                
                // Convert TRX files to HTML
                sh '~/.dotnet/tools/reportgenerator -reports:"TestResults/LiveUtils.trx" -targetdir:"TestResults/Report/LiveUtils" -reporttypes:HtmlInline_AzurePipelines_Light'
                sh 'mv TestResults/Report/LiveUtils/index.html TestResults/liveutils-report.html'
                sh '~/.dotnet/tools/reportgenerator -reports:"TestResults/LiveSeekData.trx" -targetdir:"TestResults/Report/LiveSeekData" -reporttypes:HtmlInline_AzurePipelines_Light'
                sh 'mv TestResults/Report/LiveSeekData/index.html TestResults/liveseekdata-report.html'
            }
        }
    }

    post {
        always {
            // Publish JUnit results to Jenkins dashboard
            junit 'TestResults/*-junit.xml'

            // Publish HTML reports
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'TestResults',
                reportFiles: 'liveutils-report.html,liveseekdata-report.html',
                reportName: 'LiveUtils Test Results HTML',
                reportTitles: ''
            ])
            
             // Optional: Publish Cobertura coverage if plugin is installed
             recordCoverage tools: [cobertura(pattern: 'TestResults/**/coverage.cobertura.xml')]
        }
    }
}