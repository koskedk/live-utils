pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                sh 'dotnet build'
            }
        }

        stage('Test') {
            steps {
                // Create directory for test results
                sh 'mkdir -p TestResults/Coverage'

                // Run tests with TRX and JUnit loggers
                sh '''
                dotnet test test/LiveUtils.Tests \
                  --no-build \                  
                  /p:CollectCoverage=true \
                  /p:CoverletOutput=TestResults/Coverage/LiveUtils/ \
                  /p:CoverletOutputFormat=cobertura \
                  --logger "trx;LogFileName=LiveUtils.trx" \
                  --logger "junit;LogFileName=liveutils-junit.xml" \
                  --results-directory TestResults
                '''
                sh '''
                dotnet test test/LiveUtils.LiveSeekData.Tests \
                  --no-build \
                  /p:CollectCoverage=true \
                  /p:CoverletOutput=TestResults/Coverage/LiveSeekData/ \
                  /p:CoverletOutputFormat=cobertura \
                  --logger "trx;LogFileName=LiveSeekData.trx" \
                  --logger "junit;LogFileName=liveseekdata-junit.xml" \
                  --results-directory TestResults
                '''
            }
        }

        stage('Generate HTML Reports') {
            steps {
                // Install trxlog2html .NET tool (if not already installed)
                sh 'dotnet tool install --global trxlog2html'
                
                // Convert TRX files to HTML
                sh 'trxlog2html -i TestResults/LiveUtils.trx -o TestResults/liveutils-report.html'
                sh 'trxlog2html -i TestResults/LiveSeekData.trx -o TestResults/liveseekdata-report.html'
            }
        }
    }

    post {
        always {
            // Publish JUnit results to Jenkins dashboard
            junit 'TestResults/*-junit.xml'

            // Publish HTML reports
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'TestResults',
                reportFiles: 'liveutils-report.html,liveseekdata-report.html',
                reportName: 'LiveUtils Test Results HTML',
                reportTitles: ''
            ])
            
            
             // Archive coverage reports
             archiveArtifacts artifacts: 'TestResults/Coverage/**/*.xml', allowEmptyArchive: true
             
             
             // Optional: Publish Cobertura coverage if plugin is installed
             cobertura coberturaReportFile: 'TestResults/Coverage/**/coverage.cobertura.xml'

        }
    }
}